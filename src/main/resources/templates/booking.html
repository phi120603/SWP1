<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Booking</title>
  <link rel="stylesheet" href="/css/booking-styles.css">
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo">
      <div class="logo-icon">üì¶</div>
      <span class="logo-text">QVI STORAGE</span>
    </div>
    <ul class="nav-menu">
      <li><a href="/SWP/home-page">Trang ch·ªß</a></li>
      <li><a href="/SWP/storages">Danh s√°ch</a></li>
      <li><a href="/SWP/customers/my-bookings">ƒê∆°n h√†ng c·ªßa t√¥i</a></li>
    </ul>
    <div class="nav-user">
      <span class="user-icon">üë§</span>

    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="main-content">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">ƒê·∫∑t kho</h1>
      <div class="customer-info">
        <div class="customer-subtitle">
          <span class="customer-name" th:text="${customer.fullname}">T√™n kh√°ch</span>
          <span class="customer-id">ID: <span th:text="${customer.id}">0</span></span>
        </div>
      </div>
    </div>

    <!-- Booking Form Card -->
    <div class="booking-card">
      <div class="card-header">
        <h3><i class="fas fa-calendar-plus"></i> Th√¥ng tin ƒë·∫∑t kho</h3>
      </div>

      <div class="card-content">
        <!-- Error/Success Messages -->
        <div th:if="${error}" class="message error" th:text="${error}"></div>
        <div id="dynamicMessage" class="message"></div>

        <div th:if="${storage == null}">
          <div class="message error">Kh√¥ng t√¨m th·∫•y th√¥ng tin kho!</div>
          <a th:href="@{/SWP/storages}" class="btn btn-secondary">Quay l·∫°i danh s√°ch</a>
        </div>

        <div th:if="${storage != null}">
          <!-- Hidden inputs -->
          <input type="hidden" id="storageId" th:value="${storage.storageid ?: ''}" />
          <input type="hidden" id="customerId" th:value="${customer.id}" />

          <input type="hidden" id="pricePerDay" th:value="${storage.pricePerDay ?: 0}" />

          <!-- Storage Info -->
          <div class="info-section">
            <div class="info-item">
              <label>Kho:</label>
              <span class="info-value" th:text="${storage.storagename}">T√™n kho</span>
            </div>
            <div class="info-item">
              <label>Gi√° m·ªói ng√†y:</label>
              <span class="info-value price" th:text="${storage.pricePerDay != null ? storage.pricePerDay + ' VNƒê' : 'Ch∆∞a c√≥ gi√°'}">0 VNƒê</span>
            </div>
          </div>

          <!-- Date Selection -->
          <div class="form-section">
            <div class="form-group">
              <label for="startDate">Ng√†y b·∫Øt ƒë·∫ßu:</label>
              <input type="date" id="startDate" class="form-input" th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
            </div>

            <div class="form-group">
              <label for="endDate">Ng√†y k·∫øt th√∫c:</label>
              <input type="date" id="endDate" class="form-input" th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
              <div class="calculation-loading" id="calculationLoading">ƒêang t√≠nh to√°n...</div>
            </div>
          </div>

          <!-- Total Amount -->
          <div class="total-section">
            <div class="total-amount" id="totalAmountDisplay">
              T·ªïng ti·ªÅn: 0 VNƒê
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-section">
            <div class="loading" id="loadingMessage">ƒêang x·ª≠ l√Ω...</div>
            <button id="bookingBtn" class="btn btn-primary" onclick="confirmBooking()">
              <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
            </button>
            <a th:href="@{/SWP/storages/{id}(id=${storage.storageid})}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Quay l·∫°i chi ti·∫øt
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<script>
  // Debounce function ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // H√†m t√≠nh to√°n t·ªïng ti·ªÅn th√¥ng qua API
  async function calculateTotal() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const storageIdEl = document.getElementById("storageId");
    const totalAmountDisplay = document.getElementById("totalAmountDisplay");
    const calculationLoading = document.getElementById("calculationLoading");

    // Reset display
    totalAmountDisplay.textContent = "T·ªïng ti·ªÅn: 0 VNƒê";

    if (!startDate || !endDate || !storageIdEl) {
      return;
    }

    const storageId = parseInt(storageIdEl.value);
    if (isNaN(storageId)) {
      return;
    }

    try {
      // Show loading
      calculationLoading.style.display = "block";

      const response = await fetch('/api/SWP/calculate-total', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          startDate: startDate,
          endDate: endDate,
          storageId: storageId
        })
      });

      const data = await response.json();

      if (response.ok) {
        // Success - display result
        const formattedAmount = data.totalAmount.toLocaleString('vi-VN');
        totalAmountDisplay.textContent = `T·ªïng ti·ªÅn: ${formattedAmount} VNƒê (${data.days} ng√†y)`;
        totalAmountDisplay.className = "total-amount success";
      } else {
        // Error from server
        totalAmountDisplay.textContent = data.error || "L·ªói khi t√≠nh to√°n";
        totalAmountDisplay.className = "total-amount error";
      }

    } catch (error) {
      console.error("Error calculating total:", error);
      totalAmountDisplay.textContent = "L·ªói khi t√≠nh to√°n";
      totalAmountDisplay.className = "total-amount error";
    } finally {
      // Hide loading
      calculationLoading.style.display = "none";
    }
  }

  // Debounced version ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
  const debouncedCalculateTotal = debounce(calculateTotal, 500);

  // G·∫Øn s·ª± ki·ªán onchange cho c√°c tr∆∞·ªùng ng√†y
  document.getElementById("startDate")?.addEventListener("change", debouncedCalculateTotal);
  document.getElementById("endDate")?.addEventListener("change", debouncedCalculateTotal);

  function confirmBooking() {
    try {
      // Validate form
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const storageIdEl = document.getElementById("storageId");
      const customerIdEl = document.getElementById("customerId");

      // Ki·ªÉm tra c√°c element t·ªìn t·∫°i
      if (!storageIdEl || !customerIdEl) {
        showMessage("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin c·∫ßn thi·∫øt!", "error");
        return;
      }

      const storageId = storageIdEl.value;
      const customerId = customerIdEl.value;

      if (!startDate || !endDate) {
        showMessage("Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!", "error");
        return;
      }

      if (new Date(startDate) >= new Date(endDate)) {
        showMessage("Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!", "error");
        return;
      }

      // Validate IDs
      const parsedStorageId = parseInt(storageId);
      const parsedCustomerId = parseInt(customerId);

      if (isNaN(parsedStorageId) || isNaN(parsedCustomerId)) {
        showMessage("L·ªói: ID kh√¥ng h·ª£p l·ªá!", "error");
        return;
      }

      // Disable button v√† show loading
      const bookingBtn = document.getElementById("bookingBtn");
      const loadingMessage = document.getElementById("loadingMessage");

      bookingBtn.disabled = true;
      loadingMessage.style.display = "block";

      // T·∫°o object data ƒë·ªÉ g·ª≠i
      const orderData = {
        customerId: parsedCustomerId,
        storageId: parsedStorageId,
        startDate: startDate,
        endDate: endDate,
        orderDate: new Date().toISOString().split('T')[0],
        status: "PENDING"
      };

      console.log("Sending order data:", orderData);

      // G·ª≠i AJAX request
      fetch('/api/SWP/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
      })
              .then(response => {
                console.log("Response status:", response.status);

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                  throw new Error('Server kh√¥ng tr·∫£ v·ªÅ JSON');
                }

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                console.log("Success response:", data);
                showMessage("Booking th√†nh c√¥ng! Order ID: " + data.id, "success");
                showToast("ƒê·∫∑t kho th√†nh c√¥ng!", "success");

                // Reset form
                document.getElementById("startDate").value = "";
                document.getElementById("endDate").value = "";
                document.getElementById("totalAmountDisplay").textContent = "T·ªïng ti·ªÅn: 0 VNƒê";
              })
              .catch(error => {
                console.error("Error:", error);
                showMessage("C√≥ l·ªói x·∫£y ra: " + error.message, "error");
                showToast("C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t kho!", "error");
              })
              .finally(() => {
                // Re-enable button v√† hide loading
                bookingBtn.disabled = false;
                loadingMessage.style.display = "none";
              });

    } catch (error) {
      console.error("Unexpected error:", error);
      showMessage("L·ªói kh√¥ng mong mu·ªën: " + error.message, "error");
    }
  }

  function showMessage(message, type) {
    const messageDiv = document.getElementById("dynamicMessage");
    messageDiv.className = "message " + type;
    messageDiv.textContent = message;

    // Auto hide after 5 seconds
    setTimeout(() => {
      messageDiv.textContent = "";
      messageDiv.className = "message";
    }, 5000);
  }

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  }
</script>
</body>
</html>